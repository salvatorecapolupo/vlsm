<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLSM Calculator</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        :root {
            --primary: #0f766e; /* Teal per un look piÃ¹ "istituzionale" */
            --bg: #f0fdfa;
            --card: #ffffff;
            --text: #134e4a;
            --border: #ccfbf1;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 { text-align: center; color: var(--primary); margin-bottom: 0.5rem; }
        .subtitle { text-align: center; color: #555; margin-bottom: 2rem; font-size: 0.9rem; }
        
        .container {
            background: var(--card);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        /* Tabs */
        .tabs { display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); }
        .tab { 
            padding: 0.8rem 1.5rem; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0;
            background: transparent; border: none; color: #666;
        }
        .tab.active { background: var(--border); color: var(--primary); border-bottom: 3px solid var(--primary); }

        /* Input styling */
        .input-group { margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: flex-end; }
        .input-wrapper { flex: 1; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;}
        input { padding: 0.7rem; border: 1px solid #ccc; border-radius: 6px; width: 100%; font-size: 1rem; box-sizing: border-box; }

        /* Buttons */
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.7rem 1.4rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        button:hover { filter: brightness(110%); }
        button.secondary { background-color: #64748b; }
        button.danger { background-color: #ef4444; }
        button.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* Subnet input rows */
        .subnet-row { display: grid; grid-template-columns: 2fr 1fr 50px; gap: 1rem; margin-bottom: 0.8rem; align-items: center; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 2rem; font-size: 0.95rem; background: white; }
        th { background-color: #f0fdfa; padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); color: var(--text); }
        td { padding: 0.8rem; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
        
        .math-expl { font-size: 0.85rem; color: #475569; background: #f8fafc; padding: 0.5rem; border-radius: 6px; border: 1px dashed #cbd5e1; }
        .error { color: #ef4444; padding: 1rem; background: #fee2e2; border-radius: 6px; display: none; margin-top: 1rem;}
        
        .hidden-rows-msg {
            background: #fffbeb; color: #b45309; padding: 1rem; text-align: center; font-weight: bold; border: 1px solid #fcd34d;
        }
    </style>
</head>
<body>

    <h1> VLSM - Network Planner </h1>
    <div class="subtitle"> Strumento di verifica assegnamento IP con VLSM(Variable Length Subnet Mask) </div>

    <div class="container">
        <div class="input-group">
            <div class="input-wrapper" style="flex: 2;">
                <label>Indirizzo IP (es. 10.100.0.0)</label>
                <input type="text" id="major-network" value="10.100.0.0">
            </div>
            <div class="input-wrapper" style="flex: 1;">
                <label>CIDR (/xx)</label>
                <input type="number" id="major-cidr" value="16" min="1" max="30">
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('bulk')">Generazione Massiva</button>
            <button class="tab" onclick="switchTab('manual')">VLSM Manuale</button>
        </div>

        <div id="tab-bulk" style="display: block;">
            <div class="input-group" style="background: #f1f5f9; padding: 1.5rem; border-radius: 8px;">
                <div class="input-wrapper">
                    <label>Numero di Strutture (Sottoreti)</label>
                    <input type="number" id="bulk-count" value="2000" placeholder="es. 2000">
                </div>
                <div class="input-wrapper">
                    <label>Host minimi per struttura</label>
                    <input type="number" id="bulk-hosts" value="8" placeholder="es. 8">
                </div>
                <div class="input-wrapper" style="flex:0;">
                    <label>&nbsp;</label>
                    <button onclick="calculateBulk()">Calcola piano di indirizzamento</button>
                </div>
            </div>
        </div>

        <div id="tab-manual" style="display: none;">
            <div id="subnet-container"></div>
            <div class="input-group" style="margin-top: 1rem;">
                <button class="secondary" onclick="addSubnetRow()">+ Aggiungi Sottorete</button>
                <button onclick="calculateManual()">Calcola VLSM</button>
            </div>
        </div>

        <div id="error-msg" class="error"></div>

        <div id="result-area" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2rem;">
                <h3>Risultati Allocazione</h3>
                <button class="outline" onclick="exportToCSV()">ðŸ“¥ Scarica CSV Completo</button>
            </div>
            
            <div style="background:var(--bg); padding:1rem; border-radius:6px; margin-bottom:1rem; border:1px solid var(--border);">
                <strong>Formula Applicata:</strong> <span id="formula-display"></span>
            </div>

            <table id="result-table">
                <thead>
                    <tr>
                        <th>ID / Nome</th>
                        <th>Host Rich.</th>
                        <th>Subnet</th>
                        <th>CIDR</th>
                        <th>Range Host</th>
                        <th>Broadcast</th>
                    </tr>
                </thead>
                <tbody id="result-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- UTILS ---
        function ipToLong(ip) {
            return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;
        }
        function longToIp(long) {
            return [(long >>> 24) & 255, (long >>> 16) & 255, (long >>> 8) & 255, long & 255].join('.');
        }

        // --- UI STATE ---
        let globalSubnetsData = []; // Store calculated data for CSV export

        function switchTab(mode) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-bulk').style.display = mode === 'bulk' ? 'block' : 'none';
            document.getElementById('tab-manual').style.display = mode === 'manual' ? 'block' : 'none';
            event.target.classList.add('active');
            document.getElementById('result-area').style.display = 'none';
        }

        // --- BULK CALCULATION (EXAM MODE) ---
        function calculateBulk() {
            const count = parseInt(document.getElementById('bulk-count').value);
            const hosts = parseInt(document.getElementById('bulk-hosts').value);
            const majorIpStr = document.getElementById('major-network').value;
            const majorCidr = parseInt(document.getElementById('major-cidr').value);

            if (!count || !hosts || !majorIpStr) return showError("Compila tutti i campi.");

            // 1. Math Logic
            const neededSize = hosts + 2;
            const bitsHost = Math.ceil(Math.log2(neededSize));
            const blockSize = Math.pow(2, bitsHost);
            const newCidr = 32 - bitsHost;

            // 2. Capacity Check
            const majorSize = Math.pow(2, 32 - majorCidr);
            const maxSubnets = Math.floor(majorSize / blockSize);

            if (count > maxSubnets) {
                return showError(`Impossibile! La rete /${majorCidr} supporta max ${maxSubnets} sottoreti di dimensione ${blockSize}. Tu ne hai chieste ${count}.`);
            }

            // 3. Generation loop
            let currentIp = ipToLong(majorIpStr) & (-1 << (32 - majorCidr));
            globalSubnetsData = [];

            for (let i = 0; i < count; i++) {
                globalSubnetsData.push({
                    name: `Struttura ${i + 1}`,
                    hostsReq: hosts,
                    netIp: longToIp(currentIp),
                    cidr: newCidr,
                    range: `${longToIp(currentIp + 1)} - ${longToIp(currentIp + blockSize - 2)}`,
                    broadcast: longToIp(currentIp + blockSize - 1)
                });
                currentIp += blockSize;
            }

            // 4. Render (Optimize: Show first 50 and last 5)
            renderTable(true);
            
            // 5. Show Math Formula using KaTeX
            const latex = `2^{\\lceil \\log_2(${hosts} + 2) \\rceil} = ${blockSize} \\text{ addr/subnet} \\implies /${newCidr}`;
            katex.render(latex, document.getElementById('formula-display'));
            
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('error-msg').style.display = 'none';
        }

        // --- MANUAL VLSM (Previous Logic) ---
        function addSubnetRow() {
            const div = document.createElement('div');
            div.className = 'subnet-row';
            div.innerHTML = `<input type="text" class="sub-name" placeholder="Nome"><input type="number" class="sub-hosts" placeholder="Host"><button class="danger" onclick="this.parentElement.remove()">Ã—</button>`;
            document.getElementById('subnet-container').appendChild(div);
        }
        
        // Initialize manual rows
        addSubnetRow(); addSubnetRow();

        function calculateManual() {
            // ... (Logic from previous code adapted for simplified rendering) ...
            // Simplified for brevity here as focus is on Bulk
            const majorIpStr = document.getElementById('major-network').value;
            const majorCidr = parseInt(document.getElementById('major-cidr').value);
            
            let subnets = [];
            document.querySelectorAll('.subnet-row').forEach(row => {
                const name = row.querySelector('.sub-name').value;
                const hosts = parseInt(row.querySelector('.sub-hosts').value);
                if (hosts) subnets.push({ name, hosts });
            });
            subnets.sort((a, b) => b.hosts - a.hosts); // VLSM Sort

            let currentIp = ipToLong(majorIpStr) & (-1 << (32 - majorCidr));
            globalSubnetsData = [];

            try {
                subnets.forEach(sub => {
                    let power = Math.ceil(Math.log2(sub.hosts + 2));
                    let blockSize = Math.pow(2, power);
                    globalSubnetsData.push({
                        name: sub.name,
                        hostsReq: sub.hosts,
                        netIp: longToIp(currentIp),
                        cidr: 32 - power,
                        range: `${longToIp(currentIp + 1)} - ${longToIp(currentIp + blockSize - 2)}`,
                        broadcast: longToIp(currentIp + blockSize - 1)
                    });
                    currentIp += blockSize;
                });
                renderTable(false);
                document.getElementById('formula-display').innerText = "Calcolo Variabile (VLSM Standard)";
                document.getElementById('result-area').style.display = 'block';
                document.getElementById('error-msg').style.display = 'none';
            } catch(e) { showError("Errore nel calcolo."); }
        }

        // --- RENDERING & EXPORT ---
        function renderTable(isBulk) {
            const tbody = document.getElementById('result-body');
            tbody.innerHTML = '';
            
            // Limit rendering to avoid freezing UI if > 100 rows
            const MAX_render = 50;
            const total = globalSubnetsData.length;
            
            const rowsToRender = isBulk && total > MAX_render 
                ? [...globalSubnetsData.slice(0, MAX_render), 'GAP', ...globalSubnetsData.slice(total - 5)]
                : globalSubnetsData;

            rowsToRender.forEach(row => {
                if (row === 'GAP') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="6" class="hidden-rows-msg">... ${total - MAX_render - 5} righe nascoste (Scarica CSV per vederle tutte) ...</td>`;
                    tbody.appendChild(tr);
                    return;
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.name}</td><td>${row.hostsReq}</td><td style="color:var(--primary); font-family:monospace; font-weight:bold;">${row.netIp}</td><td>/${row.cidr}</td><td>${row.range}</td><td>${row.broadcast}</td>`;
                tbody.appendChild(tr);
            });
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Nome,Host Richiesti,Network IP,CIDR,Range Utilizzabile,Broadcast\n";
            globalSubnetsData.forEach(row => {
                csvContent += `${row.name},${row.hostsReq},${row.netIp},/${row.cidr},"${row.range}",${row.broadcast}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "piano_indirizzamento_esame.csv");
            document.body.appendChild(link);
            link.click();
        }

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.style.display = 'block';
        }
    </script>
</body>
</html>
